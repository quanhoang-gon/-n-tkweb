const ids = [
  'sang2','sang3','sang4','sang5','sang6','sang7','sangCN',
  'chieu2','chieu3','chieu4','chieu5','chieu6','chieu7','chieuCN',
  'toi2','toi3','toi4','toi5','toi6','toi7','toiCN'
];

let dsNV = JSON.parse(localStorage.getItem("dsNV")) || { ql: [], pv: [], tn: [] };
let lichNV = JSON.parse(localStorage.getItem("lichNV")) || {};
let Xoa = false;
let nhanVienHienTai = "";

function hienThi(id) {
  const list = document.getElementById(id);
  list.style.display = (list.style.display === "none" || list.style.display === "") ? "block" : "none";
}

function taoRadio(id, giaTri = "Kh√¥ng") {
  const td = document.getElementById(id);
  td.innerHTML = `
    <label><input type="radio" name="${id}" value="C√≥" ${giaTri==="C√≥"?"checked":""}> C√≥</label>
    <label><input type="radio" name="${id}" value="Kh√¥ng" ${giaTri==="Kh√¥ng"?"checked":""}> Kh√¥ng</label>
  `;
}

function themNhanVien() {
  const nhom = prompt("Th√™m v√†o nh√≥m n√†o? (ql/pv/tn): ");
  const ten = prompt("Nh·∫≠p t√™n nh√¢n vi√™n:");
  if (!ten || !nhom || !dsNV[nhom]) return alert("‚ùå Nh√≥m kh√¥ng h·ª£p l·ªá ho·∫∑c t√™n tr·ªëng.");

  const ul = document.getElementById(nhom);
  const li = document.createElement("li");
  li.textContent = ten;
  li.onclick = () => { if (Xoa) {
      if (confirm("X√≥a nh√¢n vi√™n '" + ten + "'?")) {
        ul.removeChild(li);
        dsNV[nhom] = dsNV[nhom].filter(t => t !== ten);
        delete lichNV[ten];
        localStorage.setItem("dsNV", JSON.stringify(dsNV));
        localStorage.setItem("lichNV", JSON.stringify(lichNV));
      }
    } else chonNhanVien(ten);
  };
  ul.appendChild(li);
  dsNV[nhom].push(ten);
  lichNV[ten] = {};
  ids.forEach(id => lichNV[ten][id] = "Kh√¥ng");
  localStorage.setItem("dsNV", JSON.stringify(dsNV));
  localStorage.setItem("lichNV", JSON.stringify(lichNV));
  alert("‚úÖ Th√™m nh√¢n vi√™n th√†nh c√¥ng.");
}

function xoaNhanVien() {
  Xoa = !Xoa;
  document.getElementById("xoaNV").textContent = Xoa ? "Ch·ªçn t√™n ƒë·ªÉ x√≥a" : "- X√≥a";
}

function chonNhanVien(ten) {
  nhanVienHienTai = ten;
  document.getElementById("tenNV").innerText = "L·ªãch l√†m c·ªßa: " + ten;
  document.getElementById("ngay").innerText = "Th√°ng: " + (new Date().getMonth() + 1) + "/" + new Date().getFullYear();

  if (!lichNV[ten]) {
    lichNV[ten] = {};
    ids.forEach(id => lichNV[ten][id] = "Kh√¥ng");
  }

  ids.forEach(id => {
    const val = lichNV[ten][id];
    document.getElementById(id).textContent = (val === "C√≥") ? "‚úî" : "";
  });
}

function capNhat() {
  if (!nhanVienHienTai) return alert("‚ö† H√£y ch·ªçn nh√¢n vi√™n tr∆∞·ªõc!");
  ids.forEach(id => {
    const cell = document.getElementById(id);
    const radios = cell.getElementsByTagName('input');
    let giaTri = lichNV[nhanVienHienTai][id] || "Kh√¥ng";
    for (let i = 0; i < radios.length; i++) if (radios[i].checked) giaTri = radios[i].value;
    lichNV[nhanVienHienTai][id] = giaTri;
    if (giaTri === "C√≥") {
  cell.innerHTML = "‚úî";
  cell.classList.add("checked");
} else {
  cell.innerHTML = "";
  cell.classList.remove("checked");
}

  });
  localStorage.setItem("lichNV", JSON.stringify(lichNV));
  alert("üíæ ƒê√£ l∆∞u l·ªãch cho " + nhanVienHienTai);
}

function resetLuaChon() {
  if (!nhanVienHienTai) return alert("‚ö† H√£y ch·ªçn nh√¢n vi√™n tr∆∞·ªõc!");
  ids.forEach(id => taoRadio(id, lichNV[nhanVienHienTai][id]));
}

function hienThiDanhSach() {
  for (let nhom in dsNV) {
    const ul = document.getElementById(nhom);
    ul.innerHTML = "";
    dsNV[nhom].forEach(ten => {
      const li = document.createElement("li");
      li.textContent = ten;
      li.onclick = () => { if (Xoa) {
          if (confirm("X√≥a nh√¢n vi√™n '" + ten + "'?")) {
            ul.removeChild(li);
            dsNV[nhom] = dsNV[nhom].filter(t => t !== ten);
            delete lichNV[ten];
            localStorage.setItem("dsNV", JSON.stringify(dsNV));
            localStorage.setItem("lichNV", JSON.stringify(lichNV));
          }
        } else chonNhanVien(ten);
      };
      ul.appendChild(li);
    });
  }
}

document.getElementById("search").addEventListener("input", function() {
  const keyword = this.value.toLowerCase().trim();
  for (let nhom in dsNV) {
    const ul = document.getElementById(nhom);
    const lis = ul.getElementsByTagName("li");
    ul.style.display = keyword ? "block" : "none";
    for (let li of lis) {
      li.style.display = li.textContent.toLowerCase().includes(keyword) ? "list-item" : "none";
    }
  }
});

ids.forEach(id => taoRadio(id));
hienThiDanhSach();
document.getElementById("ngay").innerText = "Th√°ng: " + (new Date().getMonth() + 1) + "/" + new Date().getFullYear();
